<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Approved Feedback Feed</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap");

    body {
      background: #1c0508;
      font-family: "Poppins", sans-serif;
      color: #f5eaea;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(28, 5, 8, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .spinner {
      width: 65px;
      height: 65px;
      border: 6px solid rgba(255, 255, 255, 0.2);
      border-top-color: #ff7575;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .feed-container {
      width: 100%;
      max-width: 850px;
      margin: 80px auto;
      padding: 0 20px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .post {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px 35px 80px 35px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.45);
      transition: all 0.3s ease;
      position: relative;
      animation: fadeIn 0.6s ease;
    }

    .post:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px #1d050900;
    }

    .post-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .profile-pic {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: linear-gradient(135deg, #222, #444);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ccc;
      font-size: 1.5rem;
      box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.1);
    }

    .author-name {
      font-weight: 600;
      color: #ffe0e0;
      font-size: 1.05rem;
    }

    .post-date {
      font-size: 0.9rem;
      color: #c69d9d;
      white-space: nowrap;
      font-weight: 400;
    }

    .post-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #ffd3d3;
      margin: 24px 0 12px 0;
      line-height: 1.3;
      word-break: break-word;
    }

    .post-message {
      font-size: 1.1rem;
      line-height: 1.8;
      color: #f3dada;
      word-break: break-word;
    }

    .post-actions {
      position: absolute;
      bottom: 20px;
      right: 25px;
      display: flex;
      align-items: center;
      gap: 25px;
    }

    .action-item {
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.25s ease;
      cursor: pointer;
    }

    .action-item i {
      font-size: 1.3rem;
      transition: transform 0.25s ease;
    }

    .action-item span {
      font-size: 1rem;
      color: #f7dada;
    }

    .action-item:hover i {
      transform: scale(1.2);
    }

    .upvote i {
      color: #ffcc70;
      filter: drop-shadow(0 0 6px rgba(255, 100, 100, 0.068));
    }

    .downvote i {
      color: #ff6464;
      filter: drop-shadow(0 0 6px rgba(255, 100, 100, 0.068));
    }

    .like i {
      color: #ff6363;
      filter: drop-shadow(0 0 5px rgba(255, 70, 70, 0.5));
    }

    /* ðŸ”¥ states for new behavior */
    .active i {
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, .9));
      transform: scale(1.3);
    }

    .disabled {
      opacity: .35;
      pointer-events: none;
    }

    .no-posts {
      text-align: center;
      color: #cda3a3;
      font-size: 1.2rem;
      margin-top: 60px;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-thumb {
      background: #4d1515;
      border-radius: 8px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="feed-container" id="feedContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      orderBy,
      doc,
      updateDoc,
      increment,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7oFziUJI6MVGh6CJ7ATfd8dw8BhRPfeA",
      authDomain: "tracescfeed.firebaseapp.com",
      projectId: "tracescfeed",
      storageBucket: "tracescfeed.firebasestorage.app",
      messagingSenderId: "700797865835",
      appId: "1:700797865835:web:65ac0701c50c13edb6062e",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const feedContainer = document.getElementById("feedContainer");
    const loadingOverlay = document.getElementById("loadingOverlay");

    // ðŸ” local vote memory
    const userVotes = {};

    function timeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      const intervals = {
        year: 31536000, month: 2592000, week: 604800,
        day: 86400, hour: 3600, minute: 60, second: 1,
      };
      for (let [unit, value] of Object.entries(intervals)) {
        const count = Math.floor(seconds / value);
        if (count >= 1) {
          return count === 1
            ? `${count} ${unit} ago`
            : `${count} ${unit}s ago`;
        }
      }
      return "just now";
    }

    async function loadApprovedFeedback() {
      loadingOverlay.classList.remove("hidden");
      let posts = [];

      try {
        const q = query(
          collection(db, "Feedback"),
          where("Status", "==", "Approved"),
          where("category", "==", "Events"),
          orderBy("timestamp", "desc")
        );
        const snap = await getDocs(q);
        snap.forEach((d) => posts.push({ id: d.id, ...d.data() }));
      } catch {
        const q = query(
          collection(db, "Feedback"),
          where("Status", "==", "Approved"),
          where("category", "==", "Events")
        );
        const snap = await getDocs(q);
        snap.forEach((d) => posts.push({ id: d.id, ...d.data() }));
      }

      renderFeed(posts);
      loadingOverlay.classList.add("hidden");
    }

    function renderFeed(posts) {
      feedContainer.innerHTML = "";

      if (!posts.length) {
        feedContainer.innerHTML =
          "<p class='no-posts'>No approved feedback yet.</p>";
        return;
      }

      posts.forEach((post) => {
        const topic = post.Topic || post.topic || "Untitled Topic";
        const message = post.Message || post.message || "(No message provided)";
        const author = post.Author || post.author || "Anonymous";
        const upvotes = post.upvotes || 0;
        const downvotes = post.downvotes || 0;
        const likes = post.likes || 0;

        const dateObj = post.timestamp?.toDate
          ? post.timestamp.toDate()
          : new Date(post.timestamp || Date.now());
        const formattedDate = timeAgo(dateObj);

        const div = document.createElement("div");
        div.classList.add("post");

        div.innerHTML = `
            <div class="post-header">
              <div class="profile-info">
                <div class="profile-pic"><i class="fa-solid fa-user"></i></div>
                <div class="author-name">${author}</div>
              </div>
              <div class="post-date">${formattedDate}</div>
            </div>

            <div class="post-title">${topic}</div>
            <div class="post-message">${message}</div>

            <div class="post-actions">

                              ${post.imageURL
            ? `<div class="action-item image-view">
           <i class="fa-solid fa-image"></i>View Image
         </div>`
            : ""
          }
              <div class="action-item upvote">
                <i class="fa-solid fa-caret-up"></i>
                <span>${upvotes}</span>
              </div>

              <div class="action-item downvote">
                <i class="fa-solid fa-caret-down"></i>
                <span>${downvotes}</span>
              </div>

              <div class="action-item like">
                <i class="fa-solid fa-heart"></i>
                <span>${likes}</span>
              </div>
            </div>
          `;
        div.postData = post
        feedContainer.appendChild(div);

        const upBtn = div.querySelector(".upvote");
        const downBtn = div.querySelector(".downvote");
        const likeBtn = div.querySelector(".like");

        upBtn.onclick = () => vote(post.id, "upvote", upBtn, downBtn, likeBtn);
        downBtn.onclick = () => vote(post.id, "downvote", upBtn, downBtn, likeBtn);
        likeBtn.onclick = () => vote(post.id, "like", upBtn, downBtn, likeBtn);
      });
    }

    async function vote(postId, type, upBtn, downBtn, likeBtn) {
      if (!userVotes[postId]) {
        userVotes[postId] = { upvote: false, downvote: false, like: false };
      }

      const state = userVotes[postId];
      const ref = doc(db, "Feedback", postId);

      const upSpan = upBtn.querySelector("span");
      const downSpan = downBtn.querySelector("span");
      const likeSpan = likeBtn.querySelector("span");

      try {
        // -------- DOWNVOTE --------
        if (type === "downvote") {
          if (state.downvote) {
            await updateDoc(ref, { downvotes: increment(-1) });
            state.downvote = false;
            downSpan.textContent--;
            downBtn.classList.remove("active");
            upBtn.classList.remove("disabled");
            likeBtn.classList.remove("disabled");
            return;
          }

          state.downvote = true;
          downBtn.classList.add("active");

          if (state.upvote) {
            await updateDoc(ref, { upvotes: increment(-1) });
            state.upvote = false;
            upSpan.textContent--;
            upBtn.classList.remove("active");
          }
          if (state.like) {
            await updateDoc(ref, { likes: increment(-1) });
            state.like = false;
            likeSpan.textContent--;
            likeBtn.classList.remove("active");
          }

          await updateDoc(ref, { downvotes: increment(1) });
          downSpan.textContent++;
          upBtn.classList.add("disabled");
          likeBtn.classList.add("disabled");
          return;
        }

        // block others if downvoted
        if (state.downvote) return;

        // -------- UPVOTE --------
        if (type === "upvote") {
          if (state.upvote) {
            await updateDoc(ref, { upvotes: increment(-1) });
            state.upvote = false;
            upSpan.textContent--;
            upBtn.classList.remove("active");
          } else {
            await updateDoc(ref, { upvotes: increment(1) });
            state.upvote = true;
            upSpan.textContent++;
            upBtn.classList.add("active");
          }
        }

        // -------- LIKE --------
        if (type === "like") {
          if (state.like) {
            await updateDoc(ref, { likes: increment(-1) });
            state.like = false;
            likeSpan.textContent--;
            likeBtn.classList.remove("active");
          } else {
            await updateDoc(ref, { likes: increment(1) });
            state.like = true;
            likeSpan.textContent++;
            likeBtn.classList.add("active");
          }
        }

      } catch (err) {
        console.error("Vote failed:", err);
      }
    }

    // Modal elements
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImg");
    const closeModal = document.getElementById("closeModal");

    // Open modal when image icon is clicked
    document.addEventListener("click", (e) => {
      if (e.target.closest(".image-view")) {
        const postDiv = e.target.closest(".post");
        const postIndex = Array.from(feedContainer.children).indexOf(postDiv);
        const post = feedContainer.children[postIndex].postData; // store reference
        if (!post?.imageURL) return;

        modal.style.display = "flex";
        modalImg.src = post.imageURL;
      }
    });

    // Close modal
    closeModal.addEventListener("click", () => {
      modal.style.display = "none";
      modalImg.src = "";
    });

    // Close if click outside image
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.style.display = "none";
        modalImg.src = "";
      }
    });
    loadApprovedFeedback();
  </script>


  <!-- Image Modal -->
  <div id="imageModal" style="
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.8);
  justify-content:center;
  align-items:center;
">
    <span id="closeModal" style="
    position:absolute;
    top:20px;
    right:40px;
    font-size:2rem;
    color:#fff;
    cursor:pointer;
  ">&times;</span>
    <img id="modalImg" src="" style="
    max-width:90%;
    max-height:90%;
    border-radius:10px;
    box-shadow:0 0 20px rgba(255,255,255,0.2);
  ">
  </div>
</body>

</html>